// Этот код выполняется, когда вся страница (HTML) загружена
window.addEventListener('DOMContentLoaded', () => {

    // ============================================================
    // КОНФИГУРАЦИЯ - ВАШ SVG-ПУТЬ УЖЕ ВСТАВЛЕН
    // ============================================================
    const brainSVGPath = "M1337 1931 c-20 -10 -48 -18 -64 -19 -40 -1 -162 -59 -192 -91 -14 -15 -41 -37 -58 -50 -18 -12 -36 -34 -39 -49 -4 -15 -12 -34 -20 -42 -17 -21 -17 -133 1 -156 8 -11 15 -27 15 -38 0 -35 61 -83 123 -96 31 -6 66 -9 77 -5 17 5 20 2 20 -24 0 -66 105 -137 188 -128 26 2 54 8 63 11 12 5 22 -3 37 -28 11 -19 38 -46 59 -59 24 -15 51 -47 72 -86 19 -33 42 -63 50 -65 35 -9 71 -16 71 -14 0 8 -29 106 -35 121 -7 16 -4 18 29 12 89 -17 188 46 222 142 11 31 25 54 36 56 10 3 28 26 39 52 18 42 20 58 14 139 -8 95 -19 128 -54 160 -12 11 -30 38 -40 60 -19 43 -82 106 -106 106 -8 0 -19 9 -25 19 -29 56 -123 80 -332 86 -97 3 -123 0 -151 -14z m242 3 c27 -6 30 -10 25 -28 -6 -18 -5 -19 9 -7 37 30 136 9 182 -39 27 -28 27 -30 8 -30 -11 0 -26 7 -33 15 -8 10 -30 15 -60 15 -35 0 -49 4 -52 15 -2 10 -7 7 -14 -10 -11 -24 -11 -24 35 -18 59 6 106 -10 96 -35 -4 -9 -8 -26 -9 -37 0 -11 -14 -29 -31 -40 -16 -12 -32 -29 -34 -40 -2 -15 1 -14 20 8 57 62 131 18 94 -56 -20 -41 -18 -47 5 -18 11 13 20 36 20 52 0 28 -30 69 -50 69 -18 0 -11 49 9 60 35 18 60 11 99 -28 35 -35 60 -82 43 -82 -13 0 -81 51 -81 61 0 6 6 7 13 3 6 -4 5 1 -4 11 -9 9 -24 15 -34 13 -13 -2 -9 -11 22 -43 35 -37 100 -80 114 -77 23 5 62 -86 53 -123 -5 -21 -8 -22 -45 -12 -66 16 -117 96 -90 140 10 15 10 18 -1 15 -17 -6 -22 -71 -7 -99 10 -19 9 -25 -10 -40 l-22 -18 28 -3 c42 -5 54 -48 25 -88 -25 -33 -19 -40 10 -13 26 23 24 87 -3 106 -11 8 -17 17 -12 20 4 3 21 -5 37 -18 25 -20 29 -31 29 -69 0 -35 -6 -52 -23 -71 -13 -14 -19 -25 -13 -25 12 0 37 28 48 55 7 18 9 17 15 -10 l8 -30 1 31 c0 16 -3 34 -8 40 -4 5 -11 21 -15 37 -6 26 -5 27 24 25 30 -2 30 -3 30 -59 0 -42 -6 -65 -23 -90 -27 -40 -59 -47 -112 -25 -36 15 -37 18 -32 54 5 32 4 35 -7 20 -12 -17 -56 -26 -56 -12 0 4 14 22 30 41 46 52 36 59 -13 8 -35 -36 -50 -45 -78 -45 -19 0 -40 5 -47 10 -9 7 -9 7 -2 -2 16 -19 12 -28 -14 -28 -15 0 -33 11 -46 28 l-22 27 4 -25 c6 -49 -110 -81 -147 -40 -10 11 -20 18 -23 15 -3 -3 3 -14 14 -26 19 -21 19 -21 -5 -40 -28 -23 -84 -25 -105 -4 -22 22 -32 18 -11 -5 22 -24 8 -26 -23 -4 -25 17 -30 44 -8 44 8 0 21 8 28 18 33 45 183 87 315 87 67 0 86 4 110 21 30 22 69 81 60 90 -3 3 -13 -8 -22 -26 -21 -40 -70 -70 -117 -70 -45 0 -49 14 -10 34 17 10 21 15 11 16 -9 0 -27 -8 -40 -19 -21 -16 -88 -41 -112 -41 -4 0 0 14 9 31 8 17 11 28 5 24 -6 -3 -18 -19 -26 -36 -12 -22 -22 -29 -45 -29 -17 0 -30 5 -30 11 0 7 -11 0 -24 -14 -29 -32 -67 -43 -94 -28 -33 17 -39 12 -12 -9 24 -20 24 -21 6 -35 -10 -8 -23 -12 -28 -9 -5 4 -8 -9 -6 -27 2 -25 10 -37 33 -49 17 -8 33 -19 37 -25 5 -6 8 -5 8 3 0 6 11 12 25 12 32 0 81 24 88 44 4 9 14 12 26 9 11 -3 43 3 71 12 52 17 159 18 205 1 13 -5 11 -2 -5 8 -14 8 -33 15 -43 16 -10 0 -16 4 -13 8 4 8 53 7 109 0 9 -1 20 -10 23 -20 6 -21 36 -39 84 -49 23 -6 14 -6 -25 -3 -33 4 -63 11 -66 16 -11 17 -247 -13 -311 -39 -23 -10 -50 -13 -70 -9 -22 4 -28 3 -18 -3 22 -15 5 -24 -55 -29 -48 -4 -60 -1 -104 27 -79 51 -85 101 -21 174 47 53 93 77 148 77 24 0 62 12 101 32 l61 31 77 -16 c51 -11 80 -14 87 -7 7 7 3 10 -12 10 -34 0 -27 31 14 63 49 40 36 46 -17 8 -48 -35 -74 -39 -88 -13 -10 19 5 60 35 93 8 8 14 20 14 25 -1 5 -16 -8 -34 -30 l-33 -38 -29 18 c-29 18 -29 18 -11 -2 24 -29 22 -70 -5 -88 -45 -32 -108 -11 -108 35 0 10 -5 19 -10 19 -6 0 -8 -15 -4 -38 5 -30 2 -41 -15 -56 -26 -23 -68 -15 -80 17 -13 33 -31 115 -31 138 0 32 28 78 59 97 28 17 27 17 -71 19 -109 3 -145 -8 -174 -52 -9 -14 -24 -25 -33 -25 -24 0 -58 -26 -74 -58 -13 -26 -12 -29 10 -39 26 -13 28 -10 11 17 -17 27 16 63 54 58 19 -3 28 1 31 14 4 14 15 18 46 18 34 0 41 -3 41 -19 0 -11 5 -23 10 -26 17 -11 11 -25 -12 -25 -12 0 -30 7 -40 17 -10 9 -18 11 -18 6 0 -6 7 -16 15 -23 13 -11 13 -15 0 -33 -8 -12 -15 -34 -15 -49 0 -20 -4 -26 -15 -22 -12 5 -13 10 -4 20 6 7 9 23 7 36 -2 18 -10 23 -33 25 -28 2 -28 1 -5 -5 14 -5 26 -16 28 -25 7 -35 -108 -53 -127 -19 -10 16 -10 16 -11 0 0 -9 7 -21 16 -26 11 -6 13 -11 5 -16 -21 -14 -11 -54 20 -80 l31 -26 -27 0 c-43 0 -75 41 -76 97 -2 64 0 75 17 94 8 8 14 23 14 31 0 9 15 28 33 42 17 15 46 39 62 55 48 47 222 117 200 81 -3 -5 -2 -10 4 -10 5 0 13 5 16 10 8 13 54 13 94 -1 30 -10 51 -35 51 -58 0 -17 -42 -51 -75 -60 -22 -7 -24 -9 -9 -10 19 -1 21 -6 16 -50 -2 -27 0 -56 5 -65 6 -12 9 0 9 39 -1 53 1 58 40 93 22 20 49 43 60 49 16 11 15 11 -8 3 -26 -9 -28 -7 -28 15 0 32 -51 65 -100 65 -27 0 -31 3 -20 10 8 6 45 9 82 8 37 -1 70 1 74 5 9 9 32 9 73 1z m-280 -105 c27 -10 31 -15 26 -33 -4 -11 -9 -37 -12 -58 -5 -35 -6 -36 -34 -26 -49 17 -64 63 -26 78 15 6 4 8 -40 5 -67 -3 -74 7 -19 31 38 16 64 17 105 3z m3 -146 c9 -10 19 -37 23 -60 6 -40 24 -65 55 -76 9 -3 4 -6 -11 -6 -14 -1 -43 -12 -63 -26 -20 -13 -36 -21 -36 -18 0 4 -5 2 -12 -5 -17 -17 -89 -15 -116 3 -12 9 -26 30 -31 48 l-9 32 -1 -29 c-1 -16 7 -38 16 -48 16 -18 16 -18 0 -12 -9 3 -17 10 -17 15 0 5 -9 9 -19 9 -24 0 -62 46 -54 66 6 17 43 34 72 34 10 0 35 -11 55 -25 20 -13 36 -20 36 -15 0 5 -4 12 -10 15 -5 3 -10 20 -10 36 0 62 94 105 132 62z m361 -73 c21 0 28 -3 21 -10 -6 -6 -30 -7 -56 -4 -43 6 -45 7 -34 30 11 24 11 24 25 4 9 -13 25 -20 44 -20z m-160 -20 c6 0 -4 -11 -23 -25 -42 -31 -74 -35 -42 -5 12 12 22 26 22 31 0 6 7 8 16 5 9 -3 21 -6 27 -6z m-478 -110 c16 -6 33 -7 44 -1 9 5 23 6 30 1 10 -6 6 -12 -15 -24 -17 -8 -22 -15 -13 -16 8 0 24 6 34 14 16 11 24 10 61 -13 24 -14 44 -30 44 -35 0 -5 -29 -6 -65 -4 -68 6 -118 29 -143 66 -16 25 -14 26 23 12z m201 -17 l25 4 -21 -19 c-20 -19 -21 -19 -55 2 -43 27 -44 32 -5 18 17 -5 42 -8 56 -5z m534 -153 c0 -14 -89 -70 -111 -70 -9 0 -22 7 -30 16 -10 13 -10 17 2 25 11 7 11 9 -3 9 -22 0 -23 -23 -2 -44 8 -9 12 -16 7 -16 -5 0 -14 5 -21 12 -24 24 -19 2 6 -27 14 -16 23 -22 20 -13 -7 16 18 35 30 23 3 -3 0 -5 -6 -5 -7 0 -12 -6 -12 -14 0 -22 -17 -28 -39 -16 -26 13 -35 44 -21 69 10 19 8 20 -22 14 -27 -4 -31 -3 -21 7 7 8 40 14 80 15 37 1 84 3 103 5 l35 2 -30 8 -30 8 33 1 c17 0 32 -4 32 -9z m150 -10 c39 -7 34 -8 -35 -6 -75 1 -83 -1 -129 -31 -27 -18 -54 -33 -60 -33 -6 0 7 12 28 26 83 57 103 61 196 44z m8 -20 c22 0 31 -4 26 -11 -4 -8 -31 -10 -76 -7 -41 3 -64 2 -57 -3 8 -5 38 -9 67 -9 32 0 52 -4 52 -11 0 -8 -23 -10 -77 -7 -43 3 -67 2 -53 -2 14 -5 47 -8 73 -9 29 -1 46 -5 42 -11 -9 -14 -74 -12 -128 4 -26 8 -45 11 -42 6 6 -10 86 -30 121 -30 21 0 25 -3 16 -12 -10 -10 -78 1 -147 26 -11 4 -4 -2 15 -13 19 -11 45 -20 57 -21 35 0 36 -17 2 -24 -50 -10 -88 -7 -118 9 -48 25 -48 64 0 65 9 0 34 13 55 28 53 38 63 42 104 37 19 -3 50 -5 68 -5z m-358 -42 c0 -12 10 -32 22 -45 l21 -23 -23 0 c-26 0 -90 55 -90 77 0 8 13 13 35 13 29 0 35 -4 35 -22z m111 -85 c13 -14 18 -23 12 -19 -18 10 -16 -1 6 -38 10 -17 21 -44 25 -60 7 -27 6 -28 -21 -21 -15 3 -29 10 -31 15 -2 4 -18 33 -37 65 -19 32 -35 59 -35 61 0 2 9 4 20 4 11 0 20 -6 20 -14 0 -18 38 -66 53 -66 6 0 1 7 -11 16 -22 15 -29 38 -14 47 4 2 2 3 -3 1 -6 -1 -12 7 -12 17 -2 24 -1 24 28 -8z";

    // ============================================================
    // НОВАЯ КОНФИГУРАЦИЯ ВРЕМЕНИ (в секундах)
    // ============================================================
    const ANIMATION_DURATION = 20;     // Общая длительность цикла увеличена
    const PHASE_QUIESCENCE_END = 3;    // Фаза покоя (точки)
    const PHASE_CONNECTION_END = 7;    // Фаза соединения (появление связей)
    const PHASE_FORMATION_END = 11;    // Фаза формирования (появление мозга)
    const PHASE_HOLD_END = 16;         // НОВАЯ ФАЗА: удержание (мозг "держится")
    const PHASE_DISSOLUTION_END = 20;  // Фаза растворения (исчезновение)

    // ============================================================
    // ВИЗУАЛЬНАЯ КОНФИГУРАЦИЯ (для градиента)
    // ============================================================
    const GRADIENT_START_COLOR = '#faf9f6'; // Светло-бежевый
    const GRADIENT_END_COLOR = '#EAF2F8';   // Светло-голубой
    const PARTICLE_COLOR = '#4A4A4A';       // Темно-серый
    const NUM_PARTICLES = 500;
    const MAX_CONNECTION_DISTANCE = 100;
    const PARTICLE_SIZE = 1.5;
    const DRIFT_SPEED = 0.2;

    // ============================================================
    // НАСТРОЙКА CANVAS И ПЕРЕМЕННЫХ
    // ============================================================
    const canvas = document.getElementById('neural-canvas');
    const ctx = canvas.getContext('2d');
    let width, height, particles = [], brainPath2D;
    let startTime = Date.now();

    // ============================================================
    // КЛАСС ЧАСТИЦ (без изменений)
    // ============================================================
    class Particle {
        constructor(x, y) { this.x = x; this.y = y; this.vx = (Math.random() - 0.5) * DRIFT_SPEED * 2; this.vy = (Math.random() - 0.5) * DRIFT_SPEED * 2; }
        update() { this.x += this.vx; this.y += this.vy; if (this.x < 0) this.x = width; if (this.x > width) this.x = 0; if (this.y < 0) this.y = height; if (this.y > height) this.y = 0; }
        display(opacity = 1) { ctx.fillStyle = PARTICLE_COLOR; ctx.globalAlpha = opacity; ctx.beginPath(); ctx.arc(this.x, this.y, PARTICLE_SIZE, 0, Math.PI * 2); ctx.fill(); }
        isInsideBrain() { if (!brainPath2D) return false; return ctx.isPointInPath(brainPath2D, this.x, this.y); }
    }

    // ============================================================
    // ФУНКЦИИ-ПОМОЩНИКИ (без изменений)
    // ============================================================
    const easeInOutCubic = t => t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
    const calculatePhaseProgress = (start, end, current) => current < start ? 0 : (current > end ? 1 : easeInOutCubic((current - start) / (end - start)));
    const map = (val, s1, e1, s2, e2) => s2 + (e2 - s2) * ((val - s1) / (e1 - s1));

    // ============================================================
    // ГЛАВНЫЙ ЦИКЛ АНИМАЦИИ (изменена отрисовка фона)
    // ============================================================
    function animate() {
        const elapsedTime = (Date.now() - startTime) / 1000;
        const animationTime = elapsedTime % ANIMATION_DURATION;

        // Рисуем градиентный фон
        const gradient = ctx.createLinearGradient(0, 0, 0, height);
        gradient.addColorStop(0, GRADIENT_START_COLOR);
        gradient.addColorStop(1, GRADIENT_END_COLOR);
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, width, height);

        ctx.globalAlpha = 1;

        // Рассчитываем прогресс для каждой фазы, включая новую
        const connectionProgress = calculatePhaseProgress(PHASE_QUIESCENCE_END, PHASE_CONNECTION_END, animationTime);
        const formationProgress = calculatePhaseProgress(PHASE_CONNECTION_END, PHASE_FORMATION_END, animationTime);
        // Прогресс растворения теперь начинается после фазы удержания
        const dissolutionProgress = calculatePhaseProgress(PHASE_HOLD_END, PHASE_DISSOLUTION_END, animationTime);

        particles.forEach(p => p.update());

        drawConnections(connectionProgress, formationProgress, dissolutionProgress);
        drawParticles(formationProgress, dissolutionProgress);

        requestAnimationFrame(animate);
    }

    // ============================================================
    // ФУНКЦИИ ОТРИСОВКИ (логика остается прежней)
    // ============================================================
    function drawConnections(connProg, formProg, dissProg) {
        let connStrength = connProg * (1 - dissProg);
        if (connStrength <= 0) return;

        for (let i = 0; i < particles.length; i++) {
            for (let j = i + 1; j < particles.length; j++) {
                const p1 = particles[i], p2 = particles[j];
                const distance = Math.hypot(p1.x - p2.x, p1.y - p2.y);

                if (distance < MAX_CONNECTION_DISTANCE) {
                    let baseOpacity = map(distance, 0, MAX_CONNECTION_DISTANCE, 0.5, 0);
                    let opacity = baseOpacity * connStrength;

                    if (formProg > 0 && dissProg === 0) {
                        const p1In = p1.isInsideBrain(), p2In = p2.isInsideBrain();
                        if (p1In && p2In) {
                            opacity = map(formProg, 0, 1, baseOpacity, 1);
                        } else if (!p1In && !p2In) {
                            opacity *= (1 - formProg * 0.85);
                        }
                    }

                    if (opacity > 0.01) {
                         ctx.strokeStyle = PARTICLE_COLOR;
                         ctx.globalAlpha = opacity;
                         ctx.lineWidth = 0.5;
                         ctx.beginPath();
                         ctx.moveTo(p1.x, p1.y);
                         ctx.lineTo(p2.x, p2.y);
                         ctx.stroke();
                    }
                }
            }
        }
    }

    function drawParticles(formProg, dissProg) {
        particles.forEach(p => {
            let opacity = 1;
            // Во время удержания (formProg=1, dissProg=0), эта логика будет правильно затемнять внешние точки
            if (formProg > 0 && dissProg === 0) {
                if (!p.isInsideBrain()) {
                    opacity = 1 - formProg * 0.85;
                }
            }
            if (opacity > 0.01) {
                p.display(opacity);
            }
        });
    }

    // ============================================================
    // ИНИЦИАЛИЗАЦИЯ И МАСШТАБИРОВАНИЕ (без изменений)
    // ============================================================
    function init() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;

        particles = Array.from({ length: NUM_PARTICLES }, () => new Particle(Math.random() * width, Math.random() * height));

        const tempPath = new Path2D(brainSVGPath);
        const svgViewBoxWidth = 3000;
        const svgViewBoxHeight = 3000;
        const desiredHeight = height * 0.6;
        const scale = desiredHeight / svgViewBoxHeight;
        const scaledWidth = svgViewBoxWidth * scale;

        const matrix = new DOMMatrix();
        matrix.translate(
            width / 2 - scaledWidth / 2,
            height / 2 - desiredHeight / 2
        );
        matrix.scale(scale, scale);

        brainPath2D = new Path2D();
        brainPath2D.addPath(tempPath, matrix);
    }

    window.addEventListener('resize', init);

    init();
    animate();
});
